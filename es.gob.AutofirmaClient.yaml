app-id: es.gob.AutofirmaClient
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
command: autofirma

finish-args:
  # 'home:rw' is very broad, but AutoFirma needs to access
  # files in arbitrary locations to sign them.
  - --filesystem=home:rw
  - --filesystem=xdg-documents
  - --socket=wayland
  - --socket=x11
  - --share=ipc
  - --share=network
  - --socket=session-bus
  # Needed for DNIe readers and other smartcards
  - --device=all
  # Likely needed to access the system keystore
  - --talk-name=org.freedesktop.secrets
  - --env=PATH=/usr/bin:/app/bin:/app/jre/bin
  # Needed to call 'certutil' on the host to trust the local CA
  - --talk-name=org.flatpak.Spawn

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/install.sh

  - name: autofirma
    buildsystem: simple
    build-commands:
      # Extract the .deb
      - ar x autofirma_1_9.deb
      - tar xf data.tar.gz

      # Install main application files
      - install -d /app/lib
      - cp -r usr/lib/Autofirma/* /app/lib/

      # Install the original launcher script as autofirma.real and patch paths
      - install -d /app/bin
      - install -c usr/bin/autofirma /app/bin/autofirma.real
      - sed -i 's|/usr/lib/Autofirma|/app/lib|g' /app/bin/autofirma.real

      # Install our new wrapper as the main 'autofirma' command
      - install -c -m 0755 autofirma.bash /app/bin/autofirma

      # Install icons following the freedesktop standard
      - install -d /app/share/icons/hicolor/64x64/apps
      - install -c usr/lib/Autofirma/Autofirma.png /app/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.png

      # Install .desktop file following the freedesktop standard
      - install -d /app/share/applications
      - install -c usr/share/applications/afirma.desktop /app/share/applications/${FLATPAK_ID}.desktop
      # Patch the .desktop to use the correct command and icon
      - sed -i 's|^Exec=.*|Exec=autofirma %u|g' /app/share/applications/${FLATPAK_ID}.desktop
      - sed -i "s|^Icon=.*|Icon=${FLATPAK_ID}|g" /app/share/applications/${FLATPAK_ID}.desktop

      # Install Firefox configuration (merged module)
      - install -d /app/etc/firefox/pref
      - install -c etc/firefox/pref/Autofirma.js /app/etc/firefox/pref/

      # Install licenses and documentation
      - install -d /app/share/doc/${FLATPAK_ID}
      - cp -r usr/share/doc/Autofirma/* /app/share/doc/${FLATPAK_ID}/
      - install -d /app/share/licenses/${FLATPAK_ID}
      - cp -r usr/share/common-licenses/* /app/share/licenses/${FLATPAK_ID}/

    sources:
      - type: archive
        url: https://firmaelectronica.gob.es/content/dam/firmaelectronica/descargas-software/autofirma19/Autofirma_Linux_Debian.zip
        sha256: "c29c251f2ee9f00dfc87f9582677dbd436a83565986ab0417ff065ceae716798"
        strip-components: 0
      - type: file
        path: autofirma.bash

  # Module for application store metadata (AppStream)
  - name: metainfo
    buildsystem: simple
    build-commands:
      - install -d /app/share/metainfo
      - install -c ${FLATPAK_ID}.metainfo.xml /app/share/metainfo/
    sources:
      - type: file
        path: es.gob.AutofirmaClient.metainfo.xml
