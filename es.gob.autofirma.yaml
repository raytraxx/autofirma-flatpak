app-id: es.gob.autofirma
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
command: autofirma

finish-args:
  - --filesystem=host
  - --filesystem=~/.var/app/org.mozilla.firefox/.mozilla/firefox:rw
  - --socket=wayland
  - --socket=x11
  - --share=network
  - --socket=pcsc  # smart card support

  - --env=PATH=/usr/bin:/app/bin:/app/jre/bin
  # Likely needed to access the system keystore
  - --talk-name=org.freedesktop.secrets

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/install.sh

  - name: autofirma
    buildsystem: simple
    build-commands:
      # Extract the .deb
      - ar x autofirma_1_9.deb
      - tar xf data.tar.gz

      # Install main application files
      - install -d /app/lib
      - cp -r usr/lib/Autofirma/* /app/lib/

      # Install the original launcher script as autofirma.real and patch paths
      - install -d /app/bin
      - install -c usr/bin/autofirma /app/bin/autofirma.real
      - sed -i 's|/usr/lib/Autofirma|/app/lib|g' /app/bin/autofirma.real

      # Install our new wrapper as the main 'autofirma' command
      - install -c -m 0755 autofirma.bash /app/bin/autofirma

      # Install icons following the freedesktop standard
      - install -d /app/share/icons/hicolor/64x64/apps
      - install -c usr/lib/Autofirma/Autofirma.png /app/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.png

      # Install .desktop file following the freedesktop standard
      - install -d /app/share/applications
      - install -c usr/share/applications/afirma.desktop /app/share/applications/${FLATPAK_ID}.desktop
      # Patch the .desktop to use the correct command and icon
      - sed -i 's|^Exec=.*|Exec=autofirma %u|g' /app/share/applications/${FLATPAK_ID}.desktop
      - sed -i "s|^Icon=.*|Icon=${FLATPAK_ID}|g" /app/share/applications/${FLATPAK_ID}.desktop

      # Install licenses and documentation
      - install -d /app/share/doc/${FLATPAK_ID}
      - cp -r usr/share/doc/Autofirma/* /app/share/doc/${FLATPAK_ID}/
      - install -d /app/share/licenses/${FLATPAK_ID}
      - cp -r usr/share/common-licenses/* /app/share/licenses/${FLATPAK_ID}/

    sources:
      - type: archive
        url: https://firmaelectronica.gob.es/content/dam/firmaelectronica/descargas-software/autofirma19/Autofirma_Linux_Debian.zip
        sha256: "c29c251f2ee9f00dfc87f9582677dbd436a83565986ab0417ff065ceae716798"
        strip-components: 0
      - type: file
        path: autofirma.bash


  # 2. nspr (Netscape Portable Runtime, required by NSS)
  - name: nspr
    buildsystem: autotools
    subdir: nspr
    # no-autogen: true
    config-opts:
      # Standard Flatpak install prefix
      - --prefix=/app
      # Force a 64-bit build, required by NSPR on modern platforms
      - --enable-64bit
      # Disable debug builds, as required by Flathub policies
      - --disable-debug
      # Required for NSPR build system
      - --with-mozilla
      # Use standard POSIX threads
      - --with-pthreads
      # Ensure shared libraries (.so) are built
      - --enable-shared
      # Do not build static libraries (.a)
      - --disable-static
    sources:
      - type: archive
        url: https://archive.mozilla.org/pub/nspr/releases/v4.35/src/nspr-4.35.tar.gz
        sha256: 7ea3297ea5969b5d25a5dd8d47f2443cda88e9ee746301f6e1e1426f8a6abc8f

  - name: nss
    buildsystem: simple
    build-commands:
      - |
        cd nss
        make -j$FLATPAK_BUILDER_N_JOBS USE_64=1 \
        NSPR_INCLUDE_DIR=/app/include/nspr \
        NSPR_LIB_DIR=/app/lib \

      - |
        mkdir -p /app/bin /app/lib/pkgconfig /app/include/nss
        export NSS_DIST_DIR=$(find dist -maxdepth 1 -type d -name 'Linux*')
        cp -L $NSS_DIST_DIR/bin/certutil /app/bin/
        cp -L $NSS_DIST_DIR/bin/modutil /app/bin/
        cp -L $NSS_DIST_DIR/bin/signtool /app/bin/
        cp -L $NSS_DIST_DIR/lib/*.so /app/lib/
        cp -Lr dist/public/nss/* /app/include/nss/

    cleanup:
      - '/include'
      - '/lib/pkgconfig'
      # remove the extra tools
      - '/bin/modutil'
      - '/bin/signtool'

    sources:
      - type: archive
        url: https://ftp.mozilla.org/pub/security/nss/releases/NSS_3_98_RTM/src/nss-3.98.tar.gz
        sha256: f549cc33d35c0601674bfacf7c6ad683c187595eb4125b423238d3e9aa4209ce


  # Module for application store metadata (AppStream)
  - name: metainfo
    buildsystem: simple
    build-commands:
      - install -d /app/share/metainfo
      - install -c ${FLATPAK_ID}.metainfo.xml /app/share/metainfo/
    sources:
      - type: file
        path: es.gob.autofirma.metainfo.xml
